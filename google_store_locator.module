<?php
/**
 * @file
 * Code for the Google Store Locator feature.
 */

include_once 'google_store_locator.features.inc';

/**
 * Implements hook_menu().
 *
 * By using a render array as the page callback for this menu item then we
 * can give the map and panel elements as much room as possible to breathe.
 */
function google_store_locator_menu() {

  $items[variable_get('gsl_display_path', 'store_locator')] = array(
    'title' => 'Store Locator',
    'description' => 'Store locator map using Google Store Location Library',
    'page callback' => 'google_store_locator_default_page',
    'access arguments' => array('access content'),

  );
  $items['admin/config/search/google_store_locator'] = array(
    'title' => 'Google Store Locator',
    'description' => 'Google Store Locator Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('google_store_locator_admin_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'management',
    'weight' => 1,
  );
  return $items;
}

/**
 * Create admin form for Google Store Locator.
 */
function google_store_locator_admin_form($form, &$form_state) {

  $form['description'] = array(
    '#type' => 'item',
    '#title' => t('Google Store Locator'),
  );
  $form['google_store_locator']['gsl_json_path'] = array(
    '#type' => 'textfield',
    '#title' => t('Where is the JSON file located?'),
    '#default_value' => variable_get('gsl_json_path', 'store-locator/json'),
    '#required' => TRUE,
  );
  $form['google_store_locator']['gsl_display_path'] = array(
    '#type' => 'textfield',
    '#title' => t('What is the desired path for the store locator?'),
    '#default_value' => variable_get('gsl_display_path', 'store_locator'),
    '#description' => t('By default it will be served from /store_locator'),
    '#required' => TRUE,
  );
  $form['google_store_locator']['gsl_map_lat'] = array(
    '#type' => 'textfield',
    '#title' => t('Map center point (Latitude)'),
    '#default_value' => variable_get('gsl_map_lat', '40'),
    '#element_validate' => array('element_validate_number'),
    '#required' => TRUE,
  );
  $form['google_store_locator']['gsl_map_long'] = array(
    '#type' => 'textfield',
    '#title' => t('Map center point (Longitude)'),
    '#default_value' => variable_get('gsl_map_long', '-100'),
    '#element_validate' => array('element_validate_number'),
    '#required' => TRUE,
  );
  $form['google_store_locator']['gsl_map_zoom'] = array(
    '#type' => 'textfield',
    '#title' => t('Default zoom level'),
    '#default_value' => variable_get('gsl_map_zoom', '4'),
    '#element_validate' => array('element_validate_integer'),
    '#description' => t('Enter a value from 0-21 with 0 being the farthest distance from the earth'),
    '#required' => TRUE,
  );

  $file_path = drupal_get_path('module', 'file');

  if (module_exists('file')) {
    $form['google_store_locator']['gsl_marker_icon'] = array(
      '#title' => t('Marker Icon'),
      '#type' => 'managed_file',
      '#description' => t('The uploaded image will be displayed as the store location icon in the map.'),
      '#default_value' => variable_get('gsl_marker_icon', ''),
      '#upload_location' => 'public://gsl_marker_icon/',
    );
  }
  else {
    $form['google_store_locator']['gsl_marker_icon'] = array(
      '#markup' => t("<h6>To enable the custom marker icon feature please install the file module</h6>"),
    );
  }
  $form = system_settings_form($form);
  $form['#submit'][] = 'google_store_locator_admin_form_submit';
  return $form;
}

/**
 * Callback function for /store_locator in hook_menu().
 */
function google_store_locator_default_page() {

  $data_path = variable_get('gsl_json_path', 'store-locator/json');
  $map_zoom = variable_get('gsl_map_zoom', '4');
  $map_long = variable_get('gsl_map_long', '-100');
  $map_lat = variable_get('gsl_map_lat', '40');

  $variables = array(
    'data_path' => $data_path,
    'map_zoom' => $map_zoom,
    'map_long' => $map_long,
    'map_lat' => $map_lat,
  );

  $marker_icon_fid = variable_get('gsl_marker_icon', '');

  if (!empty($marker_icon_fid)) {
    $marker_file = file_load($marker_icon_fid);

    $variables['marker_path'] = $marker_file->uri;
  }

  return theme('google_store_locator_contents', $variables);
}

/**
 * Default implementation of the google_store_locator_contents theme hook.
 *
 * Builds the renderable array that attaches all necessary js files to the head
 * section of the page and generates the map and panel elements.
 */
function theme_google_store_locator_contents($variables) {
  $gsl_map_id = drupal_html_id('google-store-locator-map-container');

  $settings = array(
    'datapath' => $variables['data_path'],
    'mapzoom' => intval($variables['map_zoom']),
    'maplong' => $variables['map_long'],
    'maplat' => $variables['map_lat'],
    'empty_stores_msg' => isset($variables['empty_stores_msg']) ?
    $variables['empty_stores_msg'] :
    t('There are no stores available.'),
  );

  if (!empty($variables['marker_path'])) {
    $settings['marker_url'] = file_create_url($variables['marker_path']);
  }
  drupal_add_js(array(
    'gsl' => array(
      $gsl_map_id => $settings,
    ),
  ), 'setting');

  $output = array(
    'google_maps_api' => array(
      '#attached' => array(
        'js' => array('http://maps.googleapis.com/maps/api/js?sensor=false&libraries=places', 'external'),
      ),
    ),
    'compiled_js' => array(
      '#attached' => array(
        'js' => array(libraries_get_path('storelocator') . '/js/store-locator.compiled.js'),
      ),
    ),
    'build_js' => array(
      '#attached' => array(
        'js' => array(drupal_get_path('module', 'google_store_locator') . '/js/google_store_locator.js'),
      ),
    ),

    'store_locator_sheet' => array(
      '#attached' => array(
        'css' => array(libraries_get_path('storelocator') . '/css/storelocator.css'),
      ),
    ),

    'elements_sheet' => array(
      '#attached' => array(
        'css' => array(drupal_get_path('module', 'google_store_locator') . '/theme/google_store_locator.css'),
      ),
    ),

    'gsl_map_container' => array(
      '#type' => 'markup',
      '#prefix' => '<div id="' . $gsl_map_id . '" class="google-store-locator-map-container">',
      'gsl_panel' => array(
        '#markup' => '<div class="google-store-locator-panel"></div>',
      ),
      'gsl_map' => array(
        '#markup' => '<div class="google-store-locator-map"></div>',
      ),
      '#suffix' => '</div>',
    ),
  );

  return $output;
}

/**
 * Implements hook_theme().
 *
 * Registers this module's themeable functions
 */
function google_store_locator_theme() {
  // Returns an associative array of theme hook information.
  return array(
  // The outer array keys are the names of the theme functions, and the values
  // are arrays containing information about the hook.
    'google_store_locator_contents' => array(
     // Keys=names of the variables passed to the themable function,
     // value=default value of the variable if none is provided.
      'variables' => array(
        'data_path' => NULL,
        'map_zoom' => NULL,
        'map_long' => NULL,
        'map_lat' => NULL,
      ),
    ),
  );
}

/**
 * Submit callback for google_store_locator_admin_form.
 */
function google_store_locator_admin_form_submit($form, &$form_state) {
  menu_rebuild();
  $form_state['redirect'] = variable_get('gsl_display_path', 'store_locator');
}

/**
 * Form validator for google_store_locator_admin_form.
 */
function google_store_locator_admin_form_validate($form, &$form_state) {
  if ($form_state['values']['gsl_map_zoom'] > 21 ||
      $form_state['values']['gsl_map_zoom'] < 0) {
    form_set_error('gsl_map_zoom',
    t('Please enter a zoom level between 0 and 21.'));
  }
  if ($form_state['values']['gsl_map_long'] > 180 ||
      $form_state['values']['gsl_map_long'] < -180) {
    form_set_error('gsl_map_long',
    t('Please enter a longitude between -180 and 180'));
  }
  if ($form_state['values']['gsl_map_lat'] > 90 ||
      $form_state['values']['gsl_map_lat'] < -90) {
    form_set_error('gsl_map_lat',
    t('Please enter a latitude between -90 and 90'));
  }
}
